<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>API | Y.js</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/yjs-docs-zh-cn/images/yjs_favicon.png">
    <meta name="description" content="对共享数据进行强大抽象的 CRDT 框架。">
    <link rel="preload" href="/yjs-docs-zh-cn/assets/css/0.styles.ff7562c8.css" as="style"><link rel="preload" href="/yjs-docs-zh-cn/assets/js/app.d2498dcb.js" as="script"><link rel="preload" href="/yjs-docs-zh-cn/assets/js/2.c7b6054d.js" as="script"><link rel="preload" href="/yjs-docs-zh-cn/assets/js/7.7b309dc5.js" as="script"><link rel="preload" href="/yjs-docs-zh-cn/assets/js/3.d6a19d1d.js" as="script"><link rel="prefetch" href="/yjs-docs-zh-cn/assets/js/10.e32bb72d.js"><link rel="prefetch" href="/yjs-docs-zh-cn/assets/js/11.e0a07e3c.js"><link rel="prefetch" href="/yjs-docs-zh-cn/assets/js/12.d88de06b.js"><link rel="prefetch" href="/yjs-docs-zh-cn/assets/js/4.7351e2e0.js"><link rel="prefetch" href="/yjs-docs-zh-cn/assets/js/5.8eee7a66.js"><link rel="prefetch" href="/yjs-docs-zh-cn/assets/js/6.3569bd4e.js"><link rel="prefetch" href="/yjs-docs-zh-cn/assets/js/8.444df5dd.js"><link rel="prefetch" href="/yjs-docs-zh-cn/assets/js/9.8fe0424a.js">
    <link rel="stylesheet" href="/yjs-docs-zh-cn/assets/css/0.styles.ff7562c8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/yjs-docs-zh-cn/" class="home-link router-link-active"><img src="/yjs-docs-zh-cn/images/logo.png" alt="Y.js" class="logo"> <span class="site-name can-hide">Y.js</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="http://www.febeacon.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  大笑文档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/yjs-docs-zh-cn/" class="nav-link">
  文档首页
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="http://www.febeacon.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  大笑文档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/yjs-docs-zh-cn/" class="nav-link">
  文档首页
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/yjs-docs-zh-cn/routes/" class="sidebar-link">总览</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/#信息呈现绑定-binding" class="sidebar-link">信息呈现绑定 (Binding)</a></li><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/#信息分发端-provider" class="sidebar-link">信息分发端 (Provider)</a></li></ul></li><li><a href="/yjs-docs-zh-cn/routes/start.html" class="sidebar-link">开始</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/start.html#示例：观察类型" class="sidebar-link">示例：观察类型</a></li><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/start.html#示例：嵌套类型" class="sidebar-link">示例：嵌套类型</a></li><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/start.html#示例：使用并组合更新程序" class="sidebar-link">示例：使用并组合更新程序</a></li></ul></li><li><a href="/yjs-docs-zh-cn/routes/API.html" class="active sidebar-link">API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/API.html#共享类型" class="sidebar-link">共享类型</a></li><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/API.html#y-array" class="sidebar-link">Y.Array</a></li><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/API.html#y-map" class="sidebar-link">Y.Map</a></li><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/API.html#y-text" class="sidebar-link">Y.Text</a></li><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/API.html#y-xmlfragment" class="sidebar-link">Y.XmlFragment</a></li><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/API.html#t-xmlelement" class="sidebar-link">T.XmlElement</a></li><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/API.html#y-doc" class="sidebar-link">Y.Doc</a></li><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/API.html#y-doc-事件" class="sidebar-link">Y.Doc 事件</a></li><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/API.html#文档更新" class="sidebar-link">文档更新</a></li><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/API.html#相对位置" class="sidebar-link">相对位置</a></li><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/API.html#y-undomanager" class="sidebar-link">Y.UndoManager</a></li></ul></li><li><a href="/yjs-docs-zh-cn/routes/CRDT_Algorithm.html" class="sidebar-link">CRDT 算法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/CRDT_Algorithm.html#简介" class="sidebar-link">简介</a></li><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/CRDT_Algorithm.html#状态向量" class="sidebar-link">状态向量</a></li></ul></li><li><a href="/yjs-docs-zh-cn/routes/binding.html" class="sidebar-link">信息呈现绑定</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/binding.html#y-prosemirror" class="sidebar-link">y-prosemirror</a></li><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/binding.html#y-quill" class="sidebar-link">y-quill</a></li><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/binding.html#y-codemirror" class="sidebar-link">y-codemirror</a></li><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/binding.html#y-monaco" class="sidebar-link">y-monaco</a></li></ul></li><li><a href="/yjs-docs-zh-cn/routes/provider.html" class="sidebar-link">信息分发端</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/provider.html#y-webrtc" class="sidebar-link">y-webrtc</a></li><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/provider.html#y-websocket" class="sidebar-link">y-websocket</a></li><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/provider.html#y-leveldb" class="sidebar-link">y-leveldb</a></li><li class="sidebar-sub-header"><a href="/yjs-docs-zh-cn/routes/provider.html#y-dat" class="sidebar-link">y-dat</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="api">API</h1> <p><a href="https://github.com/yjs/yjs#api" target="_blank" rel="noopener noreferrer">英文原地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">Y</span> <span class="token keyword">from</span> <span class="token string">'yjs'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="共享类型"><em>共享类型</em></h2> <h2 id="y-array">Y.Array</h2> <p>一种可共享的类数组类型，支持在任何位置插入/删除元素。在内部，它使用了数组链表，必要时可以分割数组。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> yarray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Array</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="insert-index-number-content-array-object-boolean-array-string-number-uint8array-y-type"><code>insert(index:number, content:Array&lt;object|boolean|Array|string|number|Uint8Array|Y.Type&gt;)</code></h3> <p>在<code>index</code>处插入内容。请注意内容是元素的数组。<code>array.insert(0, [1])</code>在索引<code>0</code>处拼接列表并插入<code>1</code>。</p> <h3 id="push-array-object-boolean-array-string-number-uint8array-y-type"><code>push(Array&lt;Object|boolean|Array|string|number|Uint8Array|Y.Type&gt;)</code></h3> <h3 id="unshift-array-object-boolean-array-string-number-uint8array-y-type"><code>unshift(Array&lt;Object|boolean|Array|string|number|Uint8Array|Y.Type&gt;)</code></h3> <h3 id="delete-index-number-length-number"><code>delete(index:number, length:number)</code></h3> <h3 id="get-index-number"><code>get(index:number)</code></h3> <h3 id="length-number"><code>length:number</code></h3> <h3 id="foreach-function-value-object-boolean-array-string-number-uint8array-y-type-index-number-array-y-array"><code>forEach(function(value:object|boolean|Array|string|number|Uint8Array|Y.Type, index:number, array: Y.Array))</code></h3> <h3 id="map-function-t-number-yarray-m-array-m"><code>map(function(T, number, YArray):M):Array&lt;M&gt;</code></h3> <h3 id="toarray-array-object-boolean-array-string-number-uint8array-y-type"><code>toArray():Array&lt;object|boolean|Array|string|number|Uint8Array|Y.Type&gt;</code></h3> <p>将该<code>YArray</code>的内容拷贝到一个新数组中。</p> <h3 id="tojson-array-object-boolean-array-string-number"><code>toJSON():Array&lt;Object|boolean|Array|string|number&gt;</code></h3> <p>将该<code>YArray</code>的内容拷贝到一个新数组中。该方法会使用<code>toJSON</code>方法将所有子类型转换为 JSON。</p> <h3 id="symbol-iterator"><code>[Symbol.Iterator]</code></h3> <p>返回一个<code>YArray</code>迭代器，其中包含了数组中每个索引的值。</p> <p><code>for (let value of yarray) { .. }</code></p> <h3 id="observe-function-yarrayevent-transaction-void"><code>observe(function(YArrayEvent, Transaction):void)</code></h3> <p>向该类型添加一个事件侦听器，该事件侦听器将在每次修改这个类型时同步调用。如果在事件侦听器中修改了此类型，则在当前事件侦听器返回后将再次调用事件侦听器。</p> <h3 id="unobserve-function-yarrayevent-transaction-void"><code>unobserve(function(YArrayEvent, Transaction):void)</code></h3> <p>从该类型中删除<code>observe</code>事件侦听器。</p> <h3 id="observedeep-function-array-yevent-transaction-void"><code>observeDeep(function(Array&lt;YEvent&gt;, Transaction):void)</code></h3> <p>向该类型添加一个事件侦听器，该事件侦听器将在每次修改此类型或其任何子类型时同步调用。如果在事件侦听器中修改了此类型，则在当前事件侦听器返回后将再次调用事件侦听器。事件侦听器接收自己或其子程序创建的所有事件。</p> <h3 id="unobservedeep-function-array-yevent-transaction-void"><code>unobserveDeep(function(Array&lt;YEvent&gt;, Transaction):void)</code></h3> <p>从该类型中删除<code>observeDeep</code>事件监听器。</p> <h2 id="y-map">Y.Map</h2> <p>共享 Map 类型。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> ymap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="get-key-string-object-boolean-string-number-uint8array-y-type"><code>get(key:string):object|boolean|string|number|Uint8Array|Y.Type</code></h3> <h3 id="set-key-string-value-object-boolean-string-number-uint8array-y-type"><code>set(key:string, value:object|boolean|string|number|Uint8Array|Y.Type)</code></h3> <h3 id="delete-key-string"><code>delete(key:string)</code></h3> <h3 id="has-key-string-boolean"><code>has(key:string):boolean</code></h3> <h3 id="get-index-number-2"><code>get(index:number)</code></h3> <h3 id="tojson-object-string-object-boolean-array-string-number-uint8array"><code>toJSON():Object&lt;string, Object|boolean|Array|string|number|Uint8Array&gt;</code></h3> <p>将该<code>YMap</code>的<code>[key,value]</code>对复制到一个新对象。它使用<code>toJSON</code>方法将所有子类型转换为JSON。</p> <h3 id="foreach-function-value-object-boolean-array-string-number-uint8array-y-type-key-string-map-y-map"><code>forEach(function(value:object|boolean|Array|string|number|Uint8Array|Y.Type, key:string, map: Y.Map))</code></h3> <p>对每个键值对执行一次传入的函数。</p> <h3 id="symbol-iterator-2"><code>[Symbol.Iterator]</code></h3> <p>返回迭代器的<code>[key, value]</code>对。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> ymap<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="entries"><code>entries()</code></h3> <p>返回迭代器的<code>[key, value]</code>对。</p> <h3 id="values"><code>values</code></h3> <p>返回迭代器的所有值。</p> <h3 id="keys"><code>keys</code></h3> <p>返回迭代器的所有键。</p> <h3 id="observe-function-ymapevent-transaction-void"><code>observe(function(YMapEvent, Transaction):void)</code></h3> <p>向该类型添加一个事件侦听器，该事件侦听器将在每次修改这个类型时同步调用。如果在事件侦听器中修改了此类型，则在当前事件侦听器返回后将再次调用事件侦听器。</p> <h3 id="unobserve-function-ymapevent-transaction-void"><code>unobserve(function(YMapEvent, Transaction):void)</code></h3> <p>从该类型中删除<code>observe</code>事件侦听器。</p> <h3 id="observedeep-function-array-yevent-transaction-void-2"><code>observeDeep(function(Array&lt;YEvent&gt;, Transaction):void)</code></h3> <p>向该类型添加一个事件侦听器，该事件侦听器将在每次修改此类型或其任何子类型时同步调用。如果在事件侦听器中修改了此类型，则在当前事件侦听器返回后将再次调用事件侦听器。事件侦听器接收自己或其子程序创建的所有事件。</p> <h3 id="unobservedeep-function-array-yevent-transaction-void-2"><code>unobserveDeep(function(Array&lt;YEvent&gt;, Transaction):void)</code></h3> <p>从该类型中删除<code>observeDeep</code>事件监听器。</p> <h2 id="y-text">Y.Text</h2> <p>为文本的共享编辑而优化的可共享类型。它允许在文本中将属性分配给范围。这让视线该类型的服务文绑定成为可能。</p> <p>该类型还可以转换为<a href="https://quilljs.com/docs/delta" target="_blank" rel="noopener noreferrer">delta format<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。同样地，<code>YTextEvents</code>计算增量变化。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> ytext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="insert-index-number-content-string-formattingattributes-object-string-string"><code>insert(index:number, content:string, [formattingAttributes:Object&lt;string,string&gt;])</code></h3> <p>在<code>index</code>处插入一个字符串，并为其分配格式化属性。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ytext<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'bold text'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> bold<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="delete-index-number-length-number-2"><code>delete(index:number, length:number)</code></h3> <h3 id="format-index-number-length-number-formattingattributes-object-string-string"><code>format(index:number, length:number, formattingAttributes:Object&lt;string,string&gt;)</code></h3> <p>为文本中的的一定范围指定格式化属性。</p> <h3 id="applydelta-delta-opts-object-string-any"><code>applyDelta(delta, opts:Object&lt;string,any&gt;)</code></h3> <p>参见<a href="https://quilljs.com/docs/delta/" target="_blank" rel="noopener noreferrer">Quill Delta<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>可以设置防止删除结束换行的配置项，默认为<code>true</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ytext<span class="token punctuation">.</span><span class="token function">applyDelta</span><span class="token punctuation">(</span>delta<span class="token punctuation">,</span> <span class="token punctuation">{</span> sanitize<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="length-number-2"><code>length:number</code></h3> <h3 id="tostring-string"><code>toString():string</code></h3> <p>在不使用格式化配置项的情况下，将此类型转换为字符串。</p> <h3 id="tojson-string"><code>toJSON():string</code></h3> <p>参见<code>toString</code></p> <h3 id="todelta-delta"><code>toDelta():Delta</code></h3> <p>将该类型转换为<a href="https://quilljs.com/docs/delta/" target="_blank" rel="noopener noreferrer">Quill Delta<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="observe-function-ytextevent-transaction-void"><code>observe(function(YTextEvent, Transaction):void)</code></h3> <p>向该类型添加一个事件侦听器，该事件侦听器将在每次修改这个类型时同步调用。如果在事件侦听器中修改了此类型，则在当前事件侦听器返回后将再次调用事件侦听器。</p> <h3 id="unobserve-function-ytextevent-transaction-void"><code>unobserve(function(YTextEvent, Transaction):void)</code></h3> <p>从该类型中删除<code>observe</code>事件侦听器。</p> <h3 id="observedeep-function-array-yevent-transaction-void-3"><code>observeDeep(function(Array&lt;YEvent&gt;, Transaction):void)</code></h3> <p>向该类型添加一个事件侦听器，该事件侦听器将在每次修改此类型或其任何子类型时同步调用。如果在事件侦听器中修改了此类型，则在当前事件侦听器返回后将再次调用事件侦听器。事件侦听器接收自己或其子程序创建的所有事件。</p> <h3 id="unobservedeep-function-array-yevent-transaction-void-3"><code>unobserveDeep(function(Array&lt;YEvent&gt;, Transaction):void)</code></h3> <p>从该类型中删除<code>observeDeep</code>事件监听器。</p> <h2 id="y-xmlfragment">Y.XmlFragment</h2> <p>包含<code>Y.XmlElements</code>数组的容器。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> yxml <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>XmlFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="insert-index-number-content-array-y-xmlelement-y-xmltext"><code>insert(index:number, content:Array&lt;Y.XmlElement|Y.XmlText&gt;)</code></h3> <h3 id="delete-index-number-length-number-3"><code>delete(index:number, length:number)</code></h3> <h3 id="get-index-number-3"><code>get(index:number)</code></h3> <h3 id="length-number-3"><code>length:number</code></h3> <h3 id="toarray-array-y-xmlelement-y-xmltext"><code>toArray():Array&lt;Y.XmlElement|Y.XmlText&gt;</code></h3> <p>将子元素拷贝到一个新数组。</p> <h3 id="todom-documentfragment"><code>toDOM():DocumentFragment</code></h3> <p>将此类型和所有子元素转换为新的 DOM 元素。</p> <h3 id="tostring-string-2"><code>toString():string</code></h3> <p>获取所有后代的 XML 序列化。</p> <h3 id="tojson-string-2"><code>toJSON():string</code></h3> <p>参见<code>toString</code></p> <h3 id="observe-function-yxmlevent-transaction-void"><code>observe(function(YXmlEvent, Transaction):void)</code></h3> <p>向该类型添加一个事件侦听器，该事件侦听器将在每次修改这个类型时同步调用。如果在事件侦听器中修改了此类型，则在当前事件侦听器返回后将再次调用事件侦听器。</p> <h3 id="unobserve-function-yxmlevent-transaction-void"><code>unobserve(function(YXmlEvent, Transaction):void)</code></h3> <p>从该类型中删除<code>observe</code>事件侦听器。</p> <h3 id="observedeep-function-array-yevent-transaction-void-4"><code>observeDeep(function(Array&lt;YEvent&gt;, Transaction):void)</code></h3> <p>向该类型添加一个事件侦听器，该事件侦听器将在每次修改此类型或其任何子类型时同步调用。如果在事件侦听器中修改了此类型，则在当前事件侦听器返回后将再次调用事件侦听器。事件侦听器接收自己或其子程序创建的所有事件。</p> <h3 id="unobservedeep-function-array-yevent-transaction-void-4"><code>unobserveDeep(function(Array&lt;YEvent&gt;, Transaction):void)</code></h3> <p>从该类型中删除<code>observeDeep</code>事件监听器。</p> <h2 id="t-xmlelement">T.XmlElement</h2> <p>表示 XML 元素的可共享类型。它拥有<code>nodeName</code>、属性和一系列子节点。但是它不需要验证其内容，也不需要遵循 XML。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> yxml <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>XmlElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="insert-index-number-content-array-y-xmlelement-y-xmltext-2"><code>insert(index:number, content:Array&lt;Y.XmlElement|Y.XmlText&gt;)</code></h3> <h3 id="delete-index-number-length-number-4"><code>delete(index:number, length:number)</code></h3> <h3 id="get-index-number-4"><code>get(index:number)</code></h3> <h3 id="length-number-4"><code>length:number</code></h3> <h3 id="setattribute-attributename-string-attributevalue-string"><code>setAttribute(attributeName:string, attributeValue:string)</code></h3> <h3 id="removeattribute-attributename-string"><code>removeAttribute(attributeName:string)</code></h3> <h3 id="getattribute-attributename-string-string"><code>getAttribute(attributeName:string):string</code></h3> <h3 id="getattributes-attributename-string-object-string-string"><code>getAttributes(attributeName:string):Object&lt;string,string&gt;</code></h3> <h3 id="toarray-array-y-xmlelement-y-xmltext-2"><code>toArray():Array&lt;Y.XmlElement|Y.XmlText&gt;</code></h3> <p>将子元素拷贝到一个新数组。</p> <h3 id="todom-element"><code>toDOM():Element</code></h3> <p>将此类型和所有子元素转换为新的 DOM 元素。</p> <h3 id="tostring-string-3"><code>toString():string</code></h3> <p>获取所有后代的 XML 序列化。</p> <h3 id="tojson-string-3"><code>toJSON():string</code></h3> <p>参见<code>toString</code>。</p> <h3 id="observe-function-yxmlevent-transaction-void-2"><code>observe(function(YXmlEvent, Transaction):void)</code></h3> <p>向该类型添加一个事件侦听器，该事件侦听器将在每次修改这个类型时同步调用。如果在事件侦听器中修改了此类型，则在当前事件侦听器返回后将再次调用事件侦听器。</p> <h3 id="unobserve-function-yxmlevent-transaction-void-2"><code>unobserve(function(YXmlEvent, Transaction):void)</code></h3> <p>从该类型中删除<code>observe</code>事件侦听器。</p> <h3 id="observedeep-function-array-yevent-transaction-void-5"><code>observeDeep(function(Array&lt;YEvent&gt;, Transaction):void)</code></h3> <p>向该类型添加一个事件侦听器，该事件侦听器将在每次修改此类型或其任何子类型时同步调用。如果在事件侦听器中修改了此类型，则在当前事件侦听器返回后将再次调用事件侦听器。事件侦听器接收自己或其子程序创建的所有事件。</p> <h3 id="unobservedeep-function-array-yevent-transaction-void-5"><code>unobserveDeep(function(Array&lt;YEvent&gt;, Transaction):void)</code></h3> <p>从该类型中删除<code>observeDeep</code>事件监听器。</p> <h2 id="y-doc">Y.Doc</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> doc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="clientid"><code>clientID</code> <span class="badge warning" style="vertical-align:top;" data-v-76a02c50>readonly</span></h3> <p>表示客户的唯一ID。</p> <h3 id="gc"><code>gc</code></h3> <p>是否在该 doc 实例上启用了垃圾回收机制(Garbage Collection)。设置<code>doc.gc = false</code>以禁用垃圾回收并能够恢复旧内容。</p> <h3 id="transact-function-transaction-void-origin-any"><code>transact(function(Transaction):void [, origin:any])</code></h3> <p>对共享文档的每个更改都发生在一个事件流程(transaction)中。观察者调用和更新事物是在每个事件流程后。您应该将更改放到单个事件流程中以降低事件调用的数量。举个例子，<code>doc.transact(() =&gt; { yarray.insert(..); ymap.set(..) })</code>触发单个的更改事件。</p> <p>您可以通过设置可选参数<code>origin</code>，存储在<code>transaction.origin</code>和<code>on('update', (update, origin) =&gt; ..)</code>。</p> <h3 id="tojson-any"><code>toJSON():any</code></h3> <p>将整个文档转换为 js 对象，递归遍历每种 yjs 类型。</p> <h3 id="get-string-y-typeclass-type"><code>get(string, Y.[TypeClass]):[Type]</code></h3> <p>定义一个共享类型。</p> <h3 id="getarray-string-y-array"><code>getArray(string):Y.Array</code></h3> <p>定义一个共享的 Y.Array 类型。等同于<code>y.get(string, Y.Array)</code>。</p> <h3 id="getmap-string-y-map"><code>getMap(string):Y.Map</code></h3> <p>定义一个共享的 Y.Map 类型。等同于<code>y.get(string, Y.Map)</code>。</p> <h3 id="getxmlfragment-string-y-xmlfragment"><code>getXmlFragment(string):Y.XmlFragment</code></h3> <p>定义一个共享的 Y.XmlFragment 类型。等同于<code>y.get(string, Y.XmlFragment)</code>。</p> <h3 id="on-string-function">on(string, function)</h3> <p>在共享类型上注册事件侦听器。</p> <h3 id="off-string-function">off(string, function)</h3> <p>解绑共享类型上的事件侦听器。</p> <h2 id="y-doc-事件">Y.Doc 事件</h2> <h3 id="on-update-function-updatemessage-uint8array-origin-any-y-doc-void"><code>on('update', function(updateMessage:Uint8Array, origin:any, Y.Doc):void)</code></h3> <p>侦听文档更新。文档在更新时必须传输到所有其他的展示端。您可以不限顺序且多次的更新文档。</p> <h3 id="on-beforetransaction-function-y-transaction-y-doc-void"><code>on('beforeTransaction', function(Y.Transaction, Y.Doc):void)</code></h3> <p>每个事件流程开始前派发。</p> <h3 id="on-aftertransaction-function-y-transaction-y-doc-void"><code>on('afterTransaction', function(Y.Transaction, Y.Doc):void)</code></h3> <p>每个事件流程结束后派发。</p> <h3 id="on-beforealltransactions-function-y-doc-void"><code>on('beforeAllTransactions', function(Y.Doc):void)</code></h3> <p>事件流程可以嵌套(例如，在一个事件流程中调用另一个事件流程)。在首个事件流程前派发。</p> <h3 id="on-afteralltransactions-function-y-doc-array-y-transaction-void"><code>on('afterAllTransactions', function(Y.Doc, Array&lt;Y.Transaction&gt;):void)</code></h3> <p>在最后一个事件流程结束后派发。</p> <h2 id="文档更新">文档更新</h2> <p>共享文档上的更改被编码到<em>文档更新</em>中。文档更新是<em>可交换</em>且<em>幂等</em>的。这意味着它们可以以任何顺序应用且应用多次。</p> <p><strong>示例：侦听更新事件并将其应用于远程客户端</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> doc1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> doc2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

doc1<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'update'</span><span class="token punctuation">,</span> <span class="token parameter">update</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>doc2<span class="token punctuation">,</span> update<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

doc2<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'update'</span><span class="token punctuation">,</span> <span class="token parameter">update</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>doc1<span class="token punctuation">,</span> update<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 所有的更改也更新到了其他文档中</span>
doc1<span class="token punctuation">.</span><span class="token function">getArray</span><span class="token punctuation">(</span><span class="token string">'myarray'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'Hello doc2, you got this?'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
doc2<span class="token punctuation">.</span><span class="token function">getArray</span><span class="token punctuation">(</span><span class="token string">'myarray'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// =&gt; 'Hello doc2, you got this?'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>Yjs 在内部维护了**“状态向量”<strong>(后面会介绍)，用以表示每个客户端的下一个期望时钟。它保存了每个客户端创建的结构数量。当两个客户端同步时，您既可以交换完整的文档结构，也可以通过发送</strong>“状态向量”**来计算差异。</p> <p><strong>示例：通过交换完整的文档结构同步两个客户端</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> state1 <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">encodeStateAsUpdate</span><span class="token punctuation">(</span>ydoc1<span class="token punctuation">)</span>
<span class="token keyword">const</span> state2 <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">encodeStateAsUpdate</span><span class="token punctuation">(</span>ydoc2<span class="token punctuation">)</span>
<span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>ydoc1<span class="token punctuation">,</span> state2<span class="token punctuation">)</span>
<span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>ydoc2<span class="token punctuation">,</span> state1<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>示例：通过计算差异同步两个客户端</strong></p> <p>这个例子展示了如何通过使用远程客户端的“状态向量”来计算差异，从而用最少的交换数据同步两个客户端。使用状态向量同步客户端需要另一次往返，但可以保证很大的带宽安全。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> stateVector1 <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">encodeStateVector</span><span class="token punctuation">(</span>ydoc1<span class="token punctuation">)</span>
<span class="token keyword">const</span> stateVector2 <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">encodeStateVector</span><span class="token punctuation">(</span>ydoc2<span class="token punctuation">)</span>
<span class="token keyword">const</span> diff1 <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">encodeStateAsUpdate</span><span class="token punctuation">(</span>ydoc1<span class="token punctuation">,</span> stateVector2<span class="token punctuation">)</span>
<span class="token keyword">const</span> diff2 <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">encodeStateAsUpdate</span><span class="token punctuation">(</span>ydoc2<span class="token punctuation">,</span> stateVector1<span class="token punctuation">)</span>
<span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>ydoc1<span class="token punctuation">,</span> diff2<span class="token punctuation">)</span>
<span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>ydoc2<span class="token punctuation">,</span> diff1<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="y-applyupdate-y-doc-update-uint8array-transactionorigin-any"><code>Y.applyUpdate(Y.Doc, update:Uint8Array, [transactionOrigin:any])</code></h3> <p>对共享文档应用更新。您可以选择设置<code>transactionOrigin</code>从而将其存储到<code>transaction.Origin</code>和<code>ydoc.on('update', (update, origin) =&gt; ..)</code></p> <h3 id="y-encodestateasupdate-y-doc-encodedtargetstatevector-uint8array-uint8array"><code>Y.encodeStateAsUpdate(Y.Doc, [encodedTargetStateVector:Uint8Array]):Uint8Array</code></h3> <p>将文档状态编码为可应用于远程文档的单个更新消息。可以选择指定目标状态向量，以便只将差异写入更新消息。</p> <h3 id="y-encodestatevector-y-doc-uint8array"><code>Y.encodeStateVector(Y.Doc):Uint8Array</code></h3> <p>计算状态向量并将其编码为 Uint8Array。</p> <h2 id="相对位置">相对位置</h2> <div class="custom-block warning"><p class="custom-block-title">警告</p> <p>该API尚不稳定。</p></div> <p>该特性用于管理选择的内容/光标。当和操作文档的其它用户一起工作时，请不要相信索引位置是你以为的位置。<strong>相对位置</strong>会始终保持在共享文档的元素上，不受远程更改的影响。举个例子，在文档中位置是<code>“a|c”</code>则相对位置就会判断到<code>c</code>。若远程用户在光标签插入了文档，光标仍旧会停留在<code>c</code>前。<code>insert(1, 'x')(&quot;a|c&quot;) = &quot;ax|c&quot;</code>。当相对位置设置为文档结尾，那么光标就会一直停留在文档结尾了。</p> <p><strong>示例：移动到相对位置并返回</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> relPos <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">createRelativePositionFromTypeIndex</span><span class="token punctuation">(</span>ytext<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> pos <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">createAbsolutePositionFromRelativePosition</span><span class="token punctuation">(</span>relPos<span class="token punctuation">,</span> doc<span class="token punctuation">)</span>
pos<span class="token punctuation">.</span>type <span class="token operator">===</span> ytext <span class="token comment">// =&gt; true</span>
pos<span class="token punctuation">.</span>index <span class="token operator">===</span> <span class="token number">2</span> <span class="token comment">// =&gt; true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>示例：向远程客户端发送相对位置(json)</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> relPos <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">createRelativePositionFromTypeIndex</span><span class="token punctuation">(</span>ytext<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> encodedRelPos <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>relPos<span class="token punctuation">)</span>
<span class="token comment">// 向远程客户端发送 encodedRelPos。</span>
<span class="token keyword">const</span> parsedRelPos <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>encodedRelPos<span class="token punctuation">)</span>
<span class="token keyword">const</span> pos <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">createAbsolutePositionFromRelativePosition</span><span class="token punctuation">(</span>parsedRelPos<span class="token punctuation">,</span> remoteDoc<span class="token punctuation">)</span>
pos<span class="token punctuation">.</span>type <span class="token operator">===</span> remoteytext <span class="token comment">// =&gt; true</span>
pos<span class="token punctuation">.</span>index <span class="token operator">===</span> <span class="token number">2</span> <span class="token comment">// =&gt; true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>示例：发送相对位置到远程客户端(Uint8Array)</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> relPos <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">createRelativePositionFromTypeIndex</span><span class="token punctuation">(</span>ytext<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> encodedRelPos <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">encodeRelativePosition</span><span class="token punctuation">(</span>relPos<span class="token punctuation">)</span>
<span class="token comment">// 向远程客户端发送 encodedRelPos。</span>
<span class="token keyword">const</span> parsedRelPos <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">decodeRelativePosition</span><span class="token punctuation">(</span>encodedRelPos<span class="token punctuation">)</span>
<span class="token keyword">const</span> pos <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">createAbsolutePositionFromRelativePosition</span><span class="token punctuation">(</span>parsedRelPos<span class="token punctuation">,</span> remoteDoc<span class="token punctuation">)</span>
pos<span class="token punctuation">.</span>type <span class="token operator">===</span> remoteytext <span class="token comment">// =&gt; true</span>
pos<span class="token punctuation">.</span>index <span class="token operator">===</span> <span class="token number">2</span> <span class="token comment">// =&gt; true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="y-createrelativepositionfromtypeindex-uint8array-y-type-number"><code>Y.createRelativePositionFromTypeIndex(Uint8Array|Y.Type, number)</code></h3> <h3 id="y-createabsolutepositionfromrelativeposition-relativeposition-y-doc"><code>Y.createAbsolutePositionFromRelativePosition(RelativePosition, Y.Doc)</code></h3> <h3 id="y-encoderelativeposition-relativeposition-uint8array"><code>Y.encodeRelativePosition(RelativePosition):Uint8Array</code></h3> <h3 id="y-decoderelativeposition-uint8array-relativeposition"><code>Y.decodeRelativePosition(Uint8Array):RelativePosition</code></h3> <h2 id="y-undomanager">Y.UndoManager</h2> <p>Yjs 自带了撤销/重做管理器，用以应对 Yjs 类型的撤销/重做。可以选择将更改的范围限定到起始事件流程。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> ytext <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> undoManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>UndoManager</span><span class="token punctuation">(</span>ytext<span class="token punctuation">)</span>

ytext<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'abc'</span><span class="token punctuation">)</span>
undoManager<span class="token punctuation">.</span><span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ytext<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// =&gt; ''</span>
undoManager<span class="token punctuation">.</span><span class="token function">redo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ytext<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// =&gt; 'abc'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="constructor-scope-y-abstracttype-array-y-abstracttype-capturetimeout-number-trackedorigins-set-any-deletefilter-function-item-boolean"><code>constructor(scope:Y.AbstractType|Array&lt;Y.AbstractType&gt; [, {captureTimeout:number,trackedOrigins:Set&lt;any&gt;,deleteFilter:function(item):boolean}])</code></h3> <p>可以接受单个类型作为范围，也可以接受类型数组。</p> <h3 id="undo"><code>undo()</code></h3> <h3 id="redo"><code>redo()</code></h3> <h3 id="stopcapturing"><code>stopCapturing()</code></h3> <h3 id="on-stack-item-added-stackitem-meta-map-any-any-type-undo-redo"><code>on('stack-item-added', { stackItem: { meta: Map&lt;any,any&gt; }, type: 'undo' | 'redo' })</code></h3> <p>注册当<code>StackItem</code>添加到撤销栈或重做栈时调用的事件。</p> <h3 id="on-stack-item-popped-stackitem-meta-map-any-any-type-undo-redo"><code>on('stack-item-popped', { stackItem: { meta: Map&lt;any,any&gt; }, type: 'undo' | 'redo' })</code></h3> <p>注册当<code>StackItem</code>从撤销栈或重做栈移出时调用的事件。</p> <p><strong>示例：停止捕获</strong></p> <p>如果创建的时间间隔小于<code>options.captureTimeout</code>，则<code>UndoManager</code>会合并<code>Undo-StackItem</code>。调用<code>um.stopCapturing()</code>可以避免下一个<code>StackItem</code>被合并。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 无停止捕获</span>
ytext<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>
ytext<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span>
undoManager<span class="token punctuation">.</span><span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ytext<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// =&gt; '' (注意 'ab' 被移除了)</span>
<span class="token comment">// 带停止捕获</span>
ytext<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>
undoManager<span class="token punctuation">.</span><span class="token function">stopCapturing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ytext<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span>
undoManager<span class="token punctuation">.</span><span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ytext<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// =&gt; 'a' (注意只有 'b' 被)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>示例：指定追踪的起始点</strong></p> <p>共享文档上的每个更改都有一个起始点。如果没有指定起始点，则默认为<code>null</code>。通过指定<code>trackedOrigins</code>您可以有选择地指定<code>UndoManager</code>应该跟踪哪些更改。<code>UndoManager</code>实例总会被添加到<code>trackedOrigins</code>中。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">CustomBinding</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">const</span> ytext <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> undoManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>UndoManager</span><span class="token punctuation">(</span>ytext<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  trackedOrigins<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">42</span><span class="token punctuation">,</span> CustomBinding<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

ytext<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'abc'</span><span class="token punctuation">)</span>
undoManager<span class="token punctuation">.</span><span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ytext<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// =&gt; 'abc' (不跟踪，因为起始点“null”并且不是“trackedTransactionOrigins”的一部分)</span>
ytext<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 恢复</span>

doc<span class="token punctuation">.</span><span class="token function">transact</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ytext<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'abc'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">)</span>
undoManager<span class="token punctuation">.</span><span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ytext<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// =&gt; '' (跟踪，因为起始点是“trackedTransactionOrigins”的一部分)</span>

doc<span class="token punctuation">.</span><span class="token function">transact</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ytext<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'abc'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">)</span>
undoManager<span class="token punctuation">.</span><span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ytext<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// =&gt; '' (不跟踪，因为 41 不是“trackedTransactionOrigins”的一部分)</span>
ytext<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 恢复</span>

doc<span class="token punctuation">.</span><span class="token function">transact</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ytext<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'abc'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CustomBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
undoManager<span class="token punctuation">.</span><span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ytext<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// =&gt; '' (跟踪，因为起始点 `CustomBinding` 和 `CustomBinding`是 `trackedTransactionorigins`的一部分)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p><strong>示例：向<code>StackItems</code>添加其他信息</strong></p> <p>在撤消或重做以前的操作时，通常需要恢复其他元信息，如光标位置或文档上的视图。您可以为<code>Undo-/Redo-StackItems</code>分配元信息。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> ytext <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> undoManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>UndoManager</span><span class="token punctuation">(</span>ytext<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  trackedOrigins<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">42</span><span class="token punctuation">,</span> CustomBinding<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

undoManager<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'stack-item-added'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 保存 stack-item 的当前光标位置</span>
  event<span class="token punctuation">.</span>stackItem<span class="token punctuation">.</span>meta<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'cursor-location'</span><span class="token punctuation">,</span> <span class="token function">getRelativeCursorLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

undoManager<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'stack-item-popped'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 储存 stack-item 的当前光标位置</span>
  <span class="token function">restoreCursorLocation</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>stackItem<span class="token punctuation">.</span>meta<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'cursor-location'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/yjs-docs-zh-cn/routes/start.html" class="prev">
        开始
      </a></span> <span class="next"><a href="/yjs-docs-zh-cn/routes/CRDT_Algorithm.html">
        CRDT 算法
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/yjs-docs-zh-cn/assets/js/app.d2498dcb.js" defer></script><script src="/yjs-docs-zh-cn/assets/js/2.c7b6054d.js" defer></script><script src="/yjs-docs-zh-cn/assets/js/7.7b309dc5.js" defer></script><script src="/yjs-docs-zh-cn/assets/js/3.d6a19d1d.js" defer></script>
  </body>
</html>
